## 消息队列(Message Queue)和飞行窗口(Inflight Window)

每个MQTT连接会话，创建一个简单的内存消息队列，和一个正在处理消息的飞行窗口。

设计如下:

```
      |<----------------- Max Len ----------------->|
      -----------------------------------------------
IN -> |       Pending Messages   | Inflight Window  | -> Out
      -----------------------------------------------
                                 |<--- Win Size --->|
```

1. 飞行窗口(Inflight Window)保存当前正在发送未确认的Qos1/2消息。窗口值越大，吞吐越高；窗口值越小，消息顺序越严格。
2. 当客户端离线或者飞行窗口(Inflight Window)满时，消息缓存到队列。
3. 如果消息队列满，先丢弃Qos0消息，或者丢弃最早进入队列的消息。

## MQTT QoS1/2消息分配全局唯一的消息ID

每一条QoS1/2消息，分配一个全局唯一的、时间序列的消息ID，用于端到端的消息处理。

```
 PktId <-- --> MsgId <-- --> MsgId <-- --> PktId
     |<--- Qos --->|<---PubSub--->|<-- Qos -->|
```

全局唯一消息ID结构：

```
--------------------------------------------------------
|        Timestamp       |  NodeID + PID  |  Sequence  |
|<------- 64bits ------->|<--- 48bits --->|<- 16bits ->|
--------------------------------------------------------
```